<?xml version='1.0'?>
<robot name="rosbot_xl" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:arg name="mecanum" default="false" />
  <xacro:arg name="lidar_model" default="slamtec_rplidar_s1" />
  <xacro:arg name="camera_model" default="intel_realsense_d435" />
  <xacro:arg name="include_camera_mount" default="false" />
  <xacro:arg name="use_sim" default="false" />
  <xacro:arg name="simulation_engine" default="ignition-gazebo" />
  <xacro:arg name="simulation_controllers_config_file"
    default="$(find rosbot_xl_controller)/config/diff_drive_controller.yaml" />

  <xacro:include filename="$(find rosbot_xl_description)/urdf/rosbot_xl_macro.urdf.xacro"
    ns="husarion" />
  <xacro:husarion.rosbot_xl_robot use_sim="$(arg use_sim)" mecanum="$(arg mecanum)"
    simulation_engine="$(arg simulation_engine)"
    simulation_controllers_config_file="$(arg simulation_controllers_config_file)" />

  <xacro:include filename="$(find rosbot_xl_description)/urdf/components/antenna.urdf.xacro"
    ns="antenna" />
  <xacro:antenna.antenna
    parent_link="body_link"
    xyz="-0.155 -0.055 0.065"
    rpy="0.0 0.0 0.0"
    antenna_angle="0.0" />

  <!-- INCLUDE LIDAR -->

  <xacro:property name="lidar_model" value="$(arg lidar_model)" />
  <xacro:property name="lidar_parent_link" value="cover_link" />
  <xacro:property name="lidar_xyz" value="0.02 0.0 0.0" />
  <xacro:property name="lidar_rpy" value="0.0 0.0 0.0" />
  <xacro:property name="lidar_use_gpu" value="true" />
  <!-- use_gpu has to be set to true, CPU lidar doesn't work in ignition -
    https://github.com/gazebosim/gz-sensors/issues/26 -->

  <xacro:if value="${lidar_model == 'slamtec_rplidar_s1'}">
    <xacro:include filename="$(find ros_components_description)/urdf/slamtec_rplidar_s1.urdf.xacro"
      ns="lidar" />
    <xacro:lidar.slamtec_rplidar_s1
      parent_link="${lidar_parent_link}"
      xyz="${lidar_xyz}"
      rpy="${lidar_rpy}"
      use_gpu="${lidar_use_gpu}"
      simulation_engine="$(arg simulation_engine)" />
  </xacro:if>

  <xacro:if value="${lidar_model == 'slamtec_rplidar_a2'}">
    <xacro:include filename="$(find ros_components_description)/urdf/slamtec_rplidar_a2.urdf.xacro"
      ns="lidar" />
    <xacro:lidar.slamtec_rplidar_a2
      parent_link="${lidar_parent_link}"
      xyz="${lidar_xyz}"
      rpy="${lidar_rpy}"
      use_gpu="${lidar_use_gpu}"
      simulation_engine="$(arg simulation_engine)" />
  </xacro:if>

  <xacro:if value="${lidar_model == 'slamtec_rplidar_a3'}">
    <xacro:include filename="$(find ros_components_description)/urdf/slamtec_rplidar_a3.urdf.xacro"
      ns="lidar" />
    <xacro:lidar.slamtec_rplidar_a3
      parent_link="${lidar_parent_link}"
      xyz="${lidar_xyz}"
      rpy="${lidar_rpy}"
      use_gpu="${lidar_use_gpu}"
      simulation_engine="$(arg simulation_engine)" />
  </xacro:if>

  <xacro:if value="${lidar_model == 'velodyne_puck'}">
    <xacro:include filename="$(find ros_components_description)/urdf/velodyne_puck.urdf.xacro"
      ns="lidar" />
    <xacro:lidar.velodyne_puck
      parent_link="${lidar_parent_link}"
      xyz="${lidar_xyz}"
      rpy="${lidar_rpy}"
      use_gpu="${lidar_use_gpu}"
      simulation_engine="$(arg simulation_engine)"
      topic="velodyne_points" />
  </xacro:if>

  <!-- INCLUDE CAMERA -->

  <xacro:property name="camera_model" value="$(arg camera_model)" />
  <!-- <xacro:property name="camera_parent_link" value="camera_mount_link" /> -->
  <link name="gimbal_base"/>
  <link name="gimbal_mount"/>
  <link name="gimbal_optical_frame"/>

   <joint name="gimbal_optical_frame_joint" type="fixed">
            <origin xyz="0 0 0" rpy="-${3.1415926535897931/2} 0.0 -${3.1415926535897931/2}"/>
            <parent link="gimbal_base"/>
            <child link="gimbal_optical_frame"/>
        </joint>
    
  <joint name="gimbal_base_joint" type="fixed">
    <parent link="base_link" />
    <child link="gimbal_base" />

        <origin xyz="0.05 0.0 0.55" rpy="0.0 0.0 0.0" />
  </joint>

  <joint name="gimbal_mount_joint" type="floating">
    <parent link="gimbal_base" />
    <child link="gimbal_mount" />
  </joint>
  <xacro:property name="camera_parent_link" value="gimbal_mount" />
  <xacro:property name="camera_xyz" value="0.0 0.0 0.0" />
  <xacro:property name="camera_rpy" value="0.0 0.0 0.0" />

  <!-- nominal_extrinsics should be used only in simulation, when using real camera it should publish
    calibrated ones -->
  <xacro:if value="${camera_model == 'intel_realsense_d435'}">
    <xacro:include
      filename="$(find ros_components_description)/urdf/intel_realsense_d435.urdf.xacro"
      ns="camera" />
    <xacro:camera.intel_realsense_d435
      parent_link="${camera_parent_link}"
      xyz="${camera_xyz}"
      rpy="${camera_rpy}"
      name="camera"
      topic="camera"
      use_nominal_extrinsics="$(arg use_sim)"
      simulation_engine="$(arg simulation_engine)" />
  </xacro:if>

  <xacro:if value="${camera_model.startswith('stereolabs')}">
    <xacro:if value="${camera_model == 'stereolabs_zed'}">
      <xacro:property name="camera_model_type" value="zed" />
    </xacro:if>
    <xacro:if value="${camera_model == 'stereolabs_zedm'}">
      <xacro:property name="camera_model_type" value="zedm" />
    </xacro:if>
    <xacro:if value="${camera_model == 'stereolabs_zed2'}">
      <xacro:property name="camera_model_type" value="zed2" />
    </xacro:if>
    <xacro:if value="${camera_model == 'stereolabs_zed2i'}">
      <xacro:property name="camera_model_type" value="zed2i" />
    </xacro:if>
    <xacro:if value="${camera_model == 'stereolabs_zedx'}">
      <xacro:property name="camera_model_type" value="zedx" />
    </xacro:if>
    <xacro:if value="${camera_model == 'stereolabs_zedxm'}">
      <xacro:property name="camera_model_type" value="zedxm" />
    </xacro:if>

    <xacro:include
    filename="$(find ros_components_description)/urdf/stereolabs_zed.urdf.xacro"
    ns="camera" />
    <xacro:camera.zed_camera
      parent_link="${camera_parent_link}"
      xyz="${camera_xyz}"
      rpy="${camera_rpy}"
      model="${camera_model_type}"
      name="camera"
      topic="camera"
      use_nominal_extrinsics="$(arg use_sim)"
      simulation_engine="$(arg simulation_engine)" />
  </xacro:if>

  <xacro:include
      filename="$(find ros_components_description)/urdf/depthai_descr.urdf.xacro"
      ns="camera" />
    <xacro:camera.depthai_camera
      camera_name="oak" camera_model="OAK-D-PRO" parent_frame="${camera_parent_link}" base_frame="oak-d_frame"
                                           cam_pos_x="0.0" cam_pos_y="0.0" cam_pos_z="0.0" 
                                           cam_roll="0.0" cam_pitch="0.0" cam_yaw="0.0" />

                                           <!-- cam_pos_x="0.015" cam_pos_y="0.038" cam_pos_z="0.018"  -->

  <!-- INCLUDE CAMERA MOUNT - add if camera_model is not empty -->

  <xacro:property name="include_camera_mount" value="$(arg include_camera_mount)" />
  <xacro:if value="${include_camera_mount or camera_model != 'None'}">
    <xacro:include filename="$(find rosbot_xl_description)/urdf/components/camera_mount.urdf.xacro"
      ns="camera_mount" />
    <xacro:camera_mount.camera_mount
      parent_link="cover_link"
      xyz="-0.1 0.0 0.0"
      rpy="0.0 0.0 0.0"
      camera_mount_angle_1="0.0"
      camera_mount_angle_2="0.0" />
  </xacro:if>

</robot>
